{% extends "base.html" %}
{% block content %}
<div class="card mx-auto shadow-sm" style="max-width: 400px;">
    <div class="card-body">
        <h3 class="card-title mb-4 text-center">Login</h3>
        <form method="POST">
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input name="username" id="username" value="{{ username or '' }}" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" name="password" id="password" class="form-control" required>
            </div>
            {% if require_mfa %}
            <div class="mb-3">
                <label for="code" class="form-label">MFA Code</label>
                <input name="code" id="code" class="form-control" placeholder="123456" required>
            </div>
            {% endif %}    
            <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
        <p class="text-center mt-3">Don't have an account?
            <a href="{{ url_for('register') }}">Register</a>
        </p>
    </div>
  </div>
  <div class="card mx-auto shadow-sm mb-4" style="max-width: 400px;">
    <div class="card-body text-center">
      <h5 class="mb-3">Or log in with</h5>
      <a href="{{ url_for('login_google') }}" class="btn btn-danger w-100 mb-2">
        <i class="bi bi-google"></i> Google
      </a>

      <a href="{{ url_for('login_github') }}" class="btn btn-dark w-100 mb-2">
        <i class="bi bi-github"></i> GitHub
      </a>

      <a href="{{ url_for('login_microsoft') }}" class="btn btn-primary w-100 mb-2" style="background-color:#2F2F8F;">
        <i class="bi bi-microsoft"></i> Microsoft
      </a>

      <a href="{{ url_for('login_discord') }}" class="btn w-100 mb-2" style="background-color:#5865F2; color:white;">
        <i class="bi bi-discord"></i> Discord
      </a>

      <a href="{{ url_for('login_apple') }}" class="btn btn-dark w-100 mb-2">
        <i class="bi bi-apple"></i> Apple
      </a>

      <a href="{{ url_for('login_facebook') }}" class="btn btn-primary w-100" style="background-color:#1877F2;">
        <i class="bi bi-facebook"></i> Facebook
      </a>

      <button class="btn btn-secondary w-100" onclick="startPasskeyLogin()">
      <i class="bi bi-key"></i> Use Passkey
      </button>
    </div>
  </div>
<script>
async function startPasskeyLogin() {
  const email = prompt("Enter your email to use a passkey:");
  if (!email) return;

  try {
    // Step 1: request login options from the server
    const startRes = await fetch("/webauthn/login/begin", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ email })
    });
    const options = await startRes.json();

    // Step 2: decode challenge and allowCredentials IDs
    options.publicKey.challenge = Uint8Array.from(
      atob(options.publicKey.challenge.replace(/_/g, "/").replace(/-/g, "+")),
      c => c.charCodeAt(0)
    );

    if (options.publicKey.allowCredentials) {
      options.publicKey.allowCredentials = options.publicKey.allowCredentials.map(cred => ({
        ...cred,
        id: Uint8Array.from(
          atob(cred.id.replace(/_/g, "/").replace(/-/g, "+")),
          c => c.charCodeAt(0)
        )
      }));
    }

    // Step 3: get credential from browser
    const credential = await navigator.credentials.get(options);

    // Step 4: send credential to server for verification
    const completeRes = await fetch("/webauthn/login/complete", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(credential)
    });
    const result = await completeRes.json();

    if (result.status === "ok") {
      window.location.href = "/dashboard";
    } else {
      alert("Passkey login failed: " + (result.reason || "Unknown error"));
    }
  } catch (err) {
    alert("WebAuthn error: " + err.message);
  }
}
</script>
{% endblock %}
